<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Generator - Mockrise Style</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body {
      font-family: 'Noto Sans Devanagari', sans-serif;
      background: #f3f4f6;
      color: #111827;
      margin: 0;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    .toolbar {
      background: white;
      padding: 12px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: #2563eb; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-secondary { background: #6b7280; color: white; }

    .json-panel {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }

    .preview-area {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      padding: 20px;
    }

    .page {
      width: 794px; /* A4 width in px at 96 DPI approx */
      height: 1123px;
      background: white;
      margin: 20px auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      overflow: hidden;
      font-size: 14px;
      line-height: 1.35;
    }

    .page-footer {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #000;
      color: #fff;
      padding: 6px 24px;
      border-radius: 20px;
      font-size: 15px;
      font-weight: bold;
      min-width: 60px;
      text-align: center;
    }

    .page-header { height: 140px; background: #e6e6e6; position: relative; }
    .strip { position: absolute; top: 0; left: 0; width: 55px; height: 140px; background: #dcdcdc; }

    .page-title {
      position: absolute;
      top: 48px;
      left: 70px;
      right: 70px;
      text-align: center;
      font-weight: 700;
      color: #1e2937;
      font-size: 24px;
      line-height: 1.3;
      max-height: 80px;
      overflow: hidden;
    }

    .running-header { position: absolute; top: 105px; left: 80px; right: 80px; font-size: 13px; font-weight: bold; color: #222; }
    .running-left { float: left; }
    .running-right { float: right; }
    .header-line { clear: both; border-bottom: 2px solid #000; margin-top: 130px; margin-bottom: 8px; margin-left: 80px; margin-right: 80px; }

    .content-area { 
      position: absolute; 
      top: 160px; 
      bottom: 100px; 
      left: 80px; 
      right: 80px; 
      display: flex; 
      gap: 40px; 
    }
    
    .col { 
      flex: 1; 
      overflow: hidden; 
      display: flex;
      flex-direction: column;
    }

    .notes h1 {
      font-size: 22px;
      font-weight: 700;
      color: #ffffff;
      margin: 0 0 16px 0;
      padding: 10px 16px;
      background: #000000;
      border-radius: 6px;
      display: inline-block;
      box-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }

    .qbox { margin-bottom: 12px; break-inside: avoid; }
    .opt { margin-left: 16px; margin-bottom: 4px; }
    
    /* Explanation Box Styles */
    .exp { 
      margin: 8px 0 12px; 
      padding: 8px 12px; 
      border: 1px solid #666; 
      border-radius: 6px; 
      background: #f8f8f8; 
      font-size: 13px; 
      line-height: 1.4;
      text-align: justify;
    }

    /* Split Styles */
    .box-split-top {
      border-bottom: none !important;
      border-bottom-left-radius: 0 !important;
      border-bottom-right-radius: 0 !important;
      margin-bottom: 0 !important;
      padding-bottom: 10px;
    }
    
    .box-split-bottom {
      border-top: none !important;
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
      margin-top: 0 !important;
      padding-top: 10px;
      background: #f8f8f8; /* Ensure bg match */
    }

    .middleLine { position: absolute; top: 160px; bottom: 100px; left: 50%; width: 2px; background: #000; }
    .bottomLine { position: absolute; bottom: 80px; left: 80px; right: 80px; border-top: 2px solid #000; }

    /* Index Page */
    .index-page .page-header { height: 160px; background: #e6e6e6; }
    .index-page .page-title { top: 40px; font-size: 32px; background: #333; color: white; padding: 12px 50px; border-radius: 8px; left: 50%; transform: translateX(-50%); width: auto; }
    .index-page .content-area { top: 170px; left: 60px; right: 60px; display: block; }
    .index-page table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
    .index-page th, .index-page td { border: 1px solid #888; padding: 10px; text-align: center; }
    .index-page th { background: #d0d0d0; font-weight: bold; }
    .index-page td:nth-child(2) { text-align: left; padding-left: 18px; }
  </style>
</head>
<body>

<div class="container">
  <h1 style="text-align:center; margin-bottom:20px;">Book Generator - Mockrise Style</h1>

  <div class="toolbar">
    <button class="btn btn-primary" onclick="previewBook()"><i class="fas fa-eye"></i> Preview Book</button>
    <button class="btn btn-danger" onclick="clearJSON()"><i class="fas fa-trash"></i> Clear JSON</button>
    <button class="btn btn-success" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Generate PDF</button>
  </div>

  <div class="json-panel" id="jsonPanel">
    <h3><i class="fas fa-code"></i> JSON Input</h3>
    <textarea id="jsonInput" placeholder="Paste your JSON here..."></textarea>
    <div style="margin-top:12px;">
      <button class="btn btn-success" onclick="loadJSON()">Load & Preview</button>
      <button class="btn btn-secondary" onclick="document.getElementById('jsonPanel').style.display='none'">Close</button>
    </div>
  </div>

  <button class="btn btn-primary" onclick="document.getElementById('jsonPanel').style.display='block'" style="margin-bottom:20px;">
    <i class="fas fa-plus"></i> Add/Update JSON
  </button>

  <div class="preview-area" id="preview"></div>
</div>
<script>
const { jsPDF } = window.jspdf;
let bookData = { chapters: [] };

function saveJSONToStorage() {
    const jsonText = document.getElementById('jsonInput').value.trim();
    if (jsonText) localStorage.setItem('bookGeneratorJSON', jsonText);
}

function loadJSONFromStorage() {
    const saved = localStorage.getItem('bookGeneratorJSON');
    if (saved) {
        document.getElementById('jsonInput').value = saved;
        try { bookData = JSON.parse(saved); } catch (e) {}
    }
}

function clearJSON() {
    if (confirm("क्या आप सुनिश्चित हैं कि आप डेटा डिलीट करना चाहते हैं?")) {
        document.getElementById('jsonInput').value = '';
        localStorage.removeItem('bookGeneratorJSON');
        bookData = { chapters: [] };
        document.getElementById('preview').innerHTML = '';
    }
}

function clearPreview() {
    document.getElementById('preview').innerHTML = '';
}

function loadJSON() {
    try {
        const jsonText = document.getElementById('jsonInput').value;
        bookData = JSON.parse(jsonText);
        saveJSONToStorage();
        previewBook();
        document.getElementById('jsonPanel').style.display = 'none';
        alert('JSON सफलतापूर्वक लोड हो गया!');
    } catch (e) {
        alert('JSON में त्रुटि: ' + e.message);
    }
}

function createPage(pageNo, title, chapterNum, isFirst, chapName) {
    const p = document.createElement('div');
    p.className = 'page';
    
    let header = isFirst ?
        `<div class="page-header"></div><div class="strip"></div><div class="page-title">${chapterNum}. ${title}</div>` :
        `<div class="running-header"><div class="running-left">${chapName}</div><div class="running-right">Mockrise</div></div><div class="header-line"></div>`;
    
    p.innerHTML = `
        ${header}
        <div class="content-area">
            <div class="col col-left"></div>
            <div class="col col-right"></div>
        </div>
        <div class="middleLine"></div>
        <div class="bottomLine"></div>
        <div class="page-footer">${pageNo}</div>
    `;
    return p;
}

function createIndexPage(chapters) {
    const div = document.createElement('div');
    div.className = 'page index-page';
    let rows = chapters.map((c, i) =>
        `<tr><td>${i + 1}.</td><td>${c.title}</td><td>${c.start} – ${c.end}</td></tr>`
    ).join('');
    
    div.innerHTML = `
        <div class="page-header"></div><div class="strip"></div>
        <div class="page-title">विषय सूची</div>
        <div class="content-area">
            <table>
                <thead>
                    <tr><th>क्र.सं.</th><th>अध्याय</th><th>पृष्ठ सं.</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        </div>
    `;
    return div;
}

function renderIndexAndChapters() {
    const preview = document.getElementById('preview');
    preview.innerHTML = '';
    if (!bookData || !bookData.chapters || !bookData.chapters.length) return;
    
    let globalPage = 1;
    const chapterPages = [];
    
    bookData.chapters.forEach((ch, idx) => {
        const startPage = globalPage;
        let currentPageObj = createPage(globalPage, ch.title, idx + 1, true, ch.title);
        preview.appendChild(currentPageObj);
        
        let currentLeft = currentPageObj.querySelector('.col-left');
        let currentRight = currentPageObj.querySelector('.col-right');
        let currentTarget = currentLeft;
        
        const nextCol = () => {
            if (currentTarget === currentLeft) {
                currentTarget = currentRight;
            } else {
                globalPage++;
                currentPageObj = createPage(globalPage, ch.title, idx + 1, false, ch.title);
                preview.appendChild(currentPageObj);
                currentLeft = currentPageObj.querySelector('.col-left');
                currentRight = currentPageObj.querySelector('.col-right');
                currentTarget = currentLeft;
            }
        };

        // Notes Render
        if (ch.notes) {
            const notesDiv = document.createElement('div');
            notesDiv.className = 'notes';
            notesDiv.innerHTML = ch.notes;
            currentTarget.appendChild(notesDiv);
            
            if (currentTarget.scrollHeight > currentTarget.clientHeight + 5) {
                currentTarget.removeChild(notesDiv);
                nextCol();
                currentTarget.appendChild(notesDiv);
            }
        }
        
        // Questions Loop 
        ch.questions.forEach((q, qIdx) => {
            
            // लाइन ब्रेक \n फिक्स 
            const qText = q.question ? q.question.replace(/\n/g, '<br>') : '';
            
            // 1. QUESTION TITLE SPLIT LOGIC
            const qTitleDiv = document.createElement('div');
            qTitleDiv.className = 'qbox';
            qTitleDiv.style.marginBottom = '4px'; // विकल्पों के लिए थोड़ा कम मार्जिन
            qTitleDiv.innerHTML = `<b>${qIdx + 1}. ${qText}</b>`;
            
            currentTarget.appendChild(qTitleDiv);
            
            if (currentTarget.scrollHeight > currentTarget.clientHeight + 5) {
                currentTarget.removeChild(qTitleDiv);
                nextCol();
                currentTarget.appendChild(qTitleDiv);
            }
            
            // 2. OPTIONS SPLIT LOGIC (हर विकल्प अलग-अलग चेक होगा)
            if (q.options) {
                q.options.forEach((o, i) => {
                    const optText = o.replace(/\n/g, '<br>');
                    const optDiv = document.createElement('div');
                    optDiv.className = 'opt';
                    optDiv.innerHTML = `(${i + 1}) ${optText}`;
                    
                    currentTarget.appendChild(optDiv);
                    
                    if (currentTarget.scrollHeight > currentTarget.clientHeight + 5) {
                        currentTarget.removeChild(optDiv);
                        nextCol();
                        currentTarget.appendChild(optDiv);
                    }
                });
            }
            
            // 3. EXPLANATION SPLIT LOGIC (आपकी पिछली स्प्लिट स्क्रिप्ट)
            let ansText = q.answer ? q.answer.toString().replace(/\n/g, '<br>') : '';
            let expText = q.exp ? q.exp.replace(/\n/g, '<br>') : '';

            if (expText || ansText) {
                
                let content = '';
                if (ansText) content += `<div class="ans" style="margin-bottom:4px; margin-top:8px;"><b>उत्तर: (${ansText})</b></div>`;
                if (expText) content += `<b>व्याख्या:</b> ${expText}`;
                
                let remainingHTML = content;
                
                while (remainingHTML.trim() !== "") {
                    const expDiv = document.createElement('div');
                    expDiv.className = 'exp';
                    expDiv.innerHTML = remainingHTML;
                    
                    currentTarget.appendChild(expDiv);
                    
                    if (currentTarget.scrollHeight <= currentTarget.clientHeight + 5) {
                        // बॉक्स पूरा फिट हो गया
                        break;
                    }
                    
                    // बॉक्स बड़ा है -> हटाकर स्प्लिट करें (Word by Word)
                    currentTarget.removeChild(expDiv);
                    
                    let words = remainingHTML.split(" ");
                    let part = "";
                    let fittedIndex = -1;
                    
                    const tempDiv = document.createElement('div');
                    tempDiv.className = 'exp';
                    currentTarget.appendChild(tempDiv);
                    
                    for (let i = 0; i < words.length; i++) {
                        let testText = part + (i === 0 ? "" : " ") + words[i];
                        tempDiv.innerHTML = testText;
                        
                        // जगह चेक करें
                        if (currentTarget.scrollHeight > currentTarget.clientHeight) {
                            break;
                        } else {
                            part = testText;
                            fittedIndex = i;
                        }
                    }
                    
                    tempDiv.remove();
                    
                    if (part.trim() === "" || fittedIndex === -1) {
                        // एक शब्द भी फिट नहीं हो रहा, अगले कॉलम में जाएं
                        nextCol();
                        continue;
                    }
                    
                    const topPart = document.createElement('div');
                    topPart.className = 'exp';
                    topPart.innerHTML = part;
                    currentTarget.appendChild(topPart);
                    
                    remainingHTML = words.slice(fittedIndex + 1).join(" ");
                    nextCol();
                }
            }
        });
        
        chapterPages.push({ title: ch.title, start: startPage, end: globalPage });
        globalPage++;
    });
    
    const indexPage = createIndexPage(chapterPages);
    preview.insertBefore(indexPage, preview.firstChild);
}

function previewBook() {
    if (!bookData || !bookData.chapters || !bookData.chapters.length) {
        alert("JSON पहले लोड करें या सही JSON पेस्ट करें!");
        return;
    }
    renderIndexAndChapters();
}

async function generatePDF() {
    const preview = document.getElementById('preview');
    if (!preview.innerHTML || preview.innerHTML.trim() === '') {
        alert("कृपया पहले 'Preview Book' पर क्लिक करें!");
        return;
    }
    
    // PDF बनने से पहले 1 सेकंड का टाइम ताकि DOM अच्छे से रेंडर हो जाए 
    await new Promise(r => setTimeout(r, 1000));
    
    const pages = document.querySelectorAll('.page');
    if (pages.length === 0) {
        alert("कोई पेज नहीं मिला!");
        return;
    }

    const pdf = new jsPDF({ unit: 'px', format: [794, 1123], compress: true });
    
    for (let i = 0; i < pages.length; i++) {
        if (i > 0) pdf.addPage();
        const canvas = await html2canvas(pages[i], {
            scale: 1.5,
            useCORS: true,
            logging: false,
            backgroundColor: '#ffffff'
        });
        pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, 794, 1123);
    }
    
    pdf.save('Mockrise_Book.pdf');
}

window.addEventListener('load', loadJSONFromStorage);
</script>

</body>
</html>
